<section id="photos" class="photos">
  <h2 class="section-header full-width-underline">Photos</h2>

  <div class="chocolat-parent photos__grid">

    {{ range $file := first 16 (sort (union (resources.Match "favourites/*.jpeg") (resources.Match "videos/compressed/*.webm")) "Name" "desc") }}
      {{ if (eq $file.ResourceType "image") }}
        {{ $img := $file.Resize "x1024 q90"}}
        {{ $id := md5 .Name}}
        {{ $thumb := $img.Resize "x400 q75"}}
        {{ $widths := $.Site.Params.landscapePhotoWidths }}
        {{ $orientation := $img.Exif.Tags.Orientation}}
        <!-- Fix rotated photos. May not work %100 of the time. -->
        {{ if eq $orientation 6 }}
          {{ $thumb = $thumb.Resize "x400 r270" }}
          {{ $img = $img.Resize (printf "%dx r270" $img.Width) }}
          {{ $widths := $.Site.Params.portraitPhotoWidths }}
        {{ end }}

        {{ $imgSrc := "" }}
        {{ $imgSrcSet := slice }}
        {{ range $widths }}
          {{ $srcUrl := (printf "%dx" . | $img.Resize).RelPermalink }}
          {{ if eq $imgSrc "" }}{{ $imgSrc = $srcUrl }}{{ end }}
          {{ $imgSrcSet = $imgSrcSet | append (printf "%s %dw" $srcUrl .) }}
        {{ end }}
        {{ $imgSrcSet = (delimit $imgSrcSet ",") }}

        <!-- TODO Caption does not work -->
        <figure itemscope class="photos__grid__item">
          <a href="#{{ $id }}" title='{{ cond (isset $img.Exif.Tags "Caption") $img.Exif.Tags.Caption $img.Exif.Date }}'>
            <noscript class="loading-lazy">
              <img class="photos__grid__item__img" src="{{ $thumb.Permalink }}" loading="lazy" itemprop="thumbnail"/>
            </noscript>
          </a>
        </figure>

        <a href="#!" id="{{ $id }}" class="photos__grid__lightbox">
          <noscript class="loading-lazy">
            <img class="photos__grid__lightbox__img" src={{ $imgSrc }} srcset="{{ $imgSrcSet }}" loading="lazy"/>
          </noscript>
        </a>

      {{ else }}
        {{ $id := md5 .Name }}
        {{ $thumb := resources.GetMatch ($file.Title | replaceRE "compressed" "thumbs" | replaceRE ".webm" ".jpg") }}

        <figure itemscope class="photos__grid__item">
          <a href="#{{ $id }}">
            <noscript class="loading-lazy">
              <img class="photos__grid__item__img" src="{{ $thumb.Permalink }}" loading="lazy" itemprop="thumbnail"/>
            </noscript>
          </a>
        </figure>

        <a href="#!" id="{{ $id }}" class="photos__grid__lightbox">
            <noscript class="loading-lazy">
              <video controls class="photos__grid__lightbox__img" src="{{ $file.Permalink }}" preload="none" poster="{{ $thumb.Permalink }}" />
            </noscript>
        </a>
      {{ end }}
    {{ end  }}
  </div>

  <span class="more">
    <a href="/gallery">
      See more â†’
    </a>
  </span>
</section>
